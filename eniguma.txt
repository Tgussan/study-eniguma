# エニグマ
参考文献：「暗号技術入門」

## エニグマの基本情報
* 開発者：シェルビウス
* 国	：ドイツ
* 時期	：20世紀初め
* 意味	：ドイツ語で「謎」
* 使用者：ドイツの軍・商業利用もされていた・・・？

http://www1.accsnet.ne.jp/~hoshos231/howtobreakENIGMA.html

## エニグマによる暗号通信
### 前提
* 1台の機械によって暗号化・複合化を行う事が可能(送信者・受信者ともに必要)
* 日替わりの鍵・通信鍵が必要(日替わりの鍵は国防軍鍵表というものによって決められていた)


### 通信の流れ
図2-5

## エニグマの構造(本と同様にアルファベットを四文字として記述する)
図2-6

### エニグマの操作(暗号化・複合化の場合も同様)
1.入力用キーボードのaを押すと、図のように電気信号が流れ、出力用ランプが点灯する
2.送信者はランプに対応した文字を読み取って紙に書き写す

### 部品説明

#### プラグボード
結線を変えることによって文字の対応を様々に変化させるもの
結線は国防軍鍵表によって定められており、1日の間変化しない

#### ローター
図2-7
表の裏の端子同士が電線でつながっている円盤状の部品
個々のローターの結線を変えることは不可能
取り外し可能で、取り付ける順番や個々のローターの角度を選択可能(日替わりの鍵・通信鍵によって変更される)

##### ローターの動作(アルファベットを4文字とした場合)
文字を入力するごとに自動的に回転する
ローター1:使用者が一文字入力するごとに4分の1回転する
ローター2:ローター1が1回転すると、4分の1回転する
ローター3:ローター2が1回転すると、4分の1回転する

動的に変化する「あみだくじ」のような振る舞いとなる
例：一文字目に入力したa -> Bとなった場合、二文字目のaはBではなくCとなる 

## 暗号化の流れ

通信者が夜という意味のドイツ語「natch」を暗号化して送信する場合
図2-8

### 1.エニグマの設定
送信者は国防軍鍵表を用いて、その日の日替わり鍵に従い、プラグボードの結線・3枚のローターの並べ替えを行う

### 2.通信鍵の暗号化
送信者はアルファベット3文字を決め、暗号化する(通信鍵)

1.送信者が選んだ通信鍵を「psv」とする
2.ローターを日替わり鍵によって設定した状態で、「psvpsv」と2度続けて打鍵する
3.一文字打鍵する毎に点灯したランプを確認し、ランプに対応した文字をメモする
暗号化された通信鍵は「ATCDVT」とする

#### 通信エラーの回避
上記の通信鍵「psv」を2度打鍵した理由は、当時の無線通信は性能が低く、うまく通信できないことがあった為
通信鍵が正しく受信者に届かなければ、受信者は暗号を解読できない
通信鍵を2度打鍵することによって受信者が通信鍵を検証できるようにした

### 3.エニグマの再設定
通信鍵「psv」に従って3枚のローターの取り付け角度を設定する

ローター1を角度p,ローター2を角度s,ローター3を角度vにする

### 4.メッセージの暗号化
メッセージを1文字ずつキーボードから入力し、ランプに対応した文字をメモする
平文「natch」　－＞　暗号文「KXNWP」とする

### 5.通信鍵とメッセージの結合
暗号化された通信鍵「ATCDVT」と暗号文「KXNWP」を結合する
結合された文字列「ATCDVTKXNWP」を無線で送信する

## 「日替わり鍵」と「通信鍵」

エニグマで登場した上記の2種類の鍵に注目する

日替わり鍵	：メッセージではなく、通信鍵の暗号化に使用
通信鍵		：メッセージの暗号化に使用

日替わり鍵のように「鍵を暗号化するための鍵」を一般的に鍵暗号鍵(KEK:key encrypting key)と呼ぶ

1つの鍵で暗号化した暗号文の分量が多くなると、手がかりが多くなり、解読されやすくなることは、これまでの学習で得た知見である
上記のように2段構えの暗号化を行うことで、解読され辛く出来る

## エニグマの複合化
図2-9

###  1.分解
受信者は通信文の始めの6文字「ATCDVT」と残りの文字「KXNWP」に分ける

### 2.エニグマの設定
受信者は国防軍鍵表に基づき、「その日の日替わり鍵」でエニグマの設定を行う
(送信者と同様)

### 3.通信鍵の複合化
暗号化された通信鍵「ATCDVT」を複合化する
受信者はエニグマのキーボードで上記文字列を入力し、点灯した文字「psvpsv」を得る
psvが2度繰り返されていることから、通信エラーは起きなかったと判断できる

### 4.エニグマの再設定
受信者は通信鍵psvに従ってエニグマの再設定を行う(ローターの角度のみの設定)

### 5.メッセージの複合化
通信文の「KXNWP」をキーボードから入力し、「natch」という結果を読み取る

## エニグマの弱点

### 通信鍵の暗号化
最初に通信鍵の暗号化を行う際、6文字を打鍵するが、この際に回転するのはローター1のみであるという点
(ローター2以降は、本文を入力する際に26文字以上タイピングされなければ回転しない)

### 通信鍵を2度繰り替えす
暗号解読者は、通信文の最初の6文字を受信し、これの元になる平文が同じ3文字を2度繰り返したものだとわかる

### 通信鍵を決めるのが人間である
通信鍵は暗号解読者に推測されるものであってはならない
実際の送信者は、aaa,bbbという単純な通信鍵を選んでしまったことがあった
実際に通信鍵を決める際には、乱数を用いるべきだった

### 国防軍鍵表を配送する必要がある
国防軍鍵表がなければ、エニグマによる暗号通信は実現できない
国防軍鍵表が敵に渡った場合、解読されてしまう
更に、国防軍鍵表を更新する場合には、再度全軍に配送する必要がある

## 鍵輸送問題
上記のエニグマの弱点として挙げられた、鍵を配送しなければならない点
現在のコンピューターを用いた暗号通信でも非常に重要な点である
第5章で解説

## エニグマの解読

当時のフランス・イギリスの暗号解読者がスパイ活動により、エニグマの機械を入手したが、エニグマの解読は出来なかった
↓
エニグマの設計は、「隠すことによるセキュリティに頼っていないため」
エニグマは、機械の構造が分かったとしても、鍵がわからなければ解読できない仕様となっている

### 日替わり鍵の解読
ポーランドの暗号解読者レイェフスキは、日替わり鍵の解読方法を考案した

日替わり鍵は1日の間変更されない為、その1日の通信の回数分同じ鍵による暗号文が入手可能
暗号文は、「通信鍵の2回繰り返し」を暗号化した文字列を、最初の6文字として使用していることが分かっている

「ATCDVT」であれば、1,4文字目は同じ文字を暗号化した結果であり、2,5文字目、3,6文字目もそれぞれ同様に同じ文字を暗号化したものである
また、1文字目と4文字目の暗号の間に、ローターは3/26回転していることもわかる
これらの事実と大量の暗号文から、レイェフスキは暗号文の文字連鎖パターンを研究した

「暗号技術入門」では解読についてはここまで


## 暗号アルゴリズムと鍵を分ける理由

図2-10

これまでに出てきた「暗号アルゴリズム」と「鍵」を列挙する

### シーザー暗号
暗号アルゴリズム	：平文の各文字を『指定した文字数ずらす』
鍵					：ずらす文字数

### 単一漢字暗号
暗号アルゴリズム	：『換字表』に従ってアルファベットを変換する
鍵					：換字表

### エニグマ（通信鍵の暗号化）
暗号アルゴリズム	：『プラグボードの結線・3枚のローターの順序・個々のローターの角度』に従いアルファベットを変換する
鍵					：プラグボードの結線・3枚のローターの順序・個々のローターの角度

### エニグマ（通信文の暗号化）
暗号アルゴリズム	：『個々のローターの角度』に従いアルファベットを変換する
鍵					：個々のローターの角度

暗号アルゴリズムの中には、『変更可能な部分』が必ず含まれている
『変更可能な部分』とは『鍵』に相当する
暗号化のアルゴリズムと鍵を定めることによって暗号化が実現される

暗号アルゴリズムをもしも通信を行う度に考えなければならないとすると、大変なことになる
また、暗号化した文章を読み解いてほしい相手には、暗号アルゴリズムと鍵を知らせる必要が出てくる
↓
暗号アルゴリズムと鍵を分ける意図はここにある
暗号アルゴリズムは繰り返し使いたい
しかし、同じ暗号（暗号アルゴリズムと鍵と置き換えてもよい）を何度も使用すると解読される可能性が高くなる
故に、暗号アルゴリズムに『変更可能な部分』を用意しておき、通信毎に変更する
これを『鍵』という

アルゴリズムと鍵を分けることにより、『繰り返し使いたいが、繰り返すと危険である』という状況をクリアしようとしている
しかし、この状況そのものは、現在でも変わりない

暗号アルゴリズムの標準化が行われ、強固なアルゴリズムが利用されるようになった現在でも、暗号文の機密性が低くなっているわけではない
『鍵』を知られてしまえば、機密情報はたやすく漏れてしまう
故に『鍵』の管理が非常に重要となる(11章)



